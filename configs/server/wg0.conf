# WireGuard Server Configuration (with QUIC-TCP DPI bypass)
# Location: /etc/wireguard/wg0.conf

[Interface]
Address = 10.0.0.1/24,fd00::1/64
# ListenPort MUST match the QUIC-TCP port in wg0.quictcp.conf
ListenPort = 443
MTU = 1280
PrivateKey = <server-private-key>

# QUIC-TCP iptables rules
# CRITICAL: Block RST packets on port 443 (required for raw TCP to work)
PostUp = iptables -A OUTPUT -p tcp --sport 443 --tcp-flags RST RST -j DROP
PostUp = ip6tables -A OUTPUT -p tcp --sport 443 --tcp-flags RST RST -j DROP

# Allow incoming TCP on port 443
PostUp = iptables -I INPUT -p tcp --dport 443 -j ACCEPT
PostUp = ip6tables -I INPUT -p tcp --dport 443 -j ACCEPT

# Standard forwarding and NAT rules
PostUp = iptables -I FORWARD -i eth0 -o wg0 -j ACCEPT
PostUp = iptables -I FORWARD -i wg0 -j ACCEPT
PostUp = iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
PostUp = ip6tables -I FORWARD -i wg0 -j ACCEPT
PostUp = ip6tables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

# Cleanup rules
PostDown = iptables -D OUTPUT -p tcp --sport 443 --tcp-flags RST RST -j DROP
PostDown = ip6tables -D OUTPUT -p tcp --sport 443 --tcp-flags RST RST -j DROP
PostDown = iptables -D INPUT -p tcp --dport 443 -j ACCEPT
PostDown = ip6tables -D INPUT -p tcp --dport 443 -j ACCEPT
PostDown = iptables -D FORWARD -i eth0 -o wg0 -j ACCEPT
PostDown = iptables -D FORWARD -i wg0 -j ACCEPT
PostDown = iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE
PostDown = ip6tables -D FORWARD -i wg0 -j ACCEPT
PostDown = ip6tables -t nat -D POSTROUTING -o eth0 -j MASQUERADE

### Client peer
[Peer]
PublicKey = <client-public-key>
PresharedKey = <preshared-key>
AllowedIPs = 10.0.0.2/32,fd00::2/128
